<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Predictor - Advanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px 0;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #64b5f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2em;
            color: #b3d9ff;
        }
        
        .ai-indicators {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .ai-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .tab:hover {
            background: #333;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .sector-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sector-card:hover {
            background: #252525;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .sector-card.active {
            background: #2a5298;
            border-color: #64b5f6;
        }
        
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stock-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stock-symbol {
            font-size: 1.4em;
            font-weight: bold;
            color: #64b5f6;
        }
        
        .stock-price {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .positive {
            color: #4caf50;
        }
        
        .negative {
            color: #f44336;
        }
        
        .ai-analysis {
            background: rgba(42, 82, 152, 0.1);
            border: 1px solid rgba(42, 82, 152, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
        }
        
        .sentiment-bar {
            display: flex;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            background: #333;
        }
        
        .sentiment-positive {
            background: #4caf50;
        }
        
        .sentiment-neutral {
            background: #ff9800;
        }
        
        .sentiment-negative {
            background: #f44336;
        }
        
        .indicators-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .indicator {
            background: #252525;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            border: 1px solid #444;
        }
        
        .recommendation {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid;
        }
        
        .recommendation.buy {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .recommendation.sell {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .recommendation.hold {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .confidence-bar {
            flex: 1;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336, #ff9800, #4caf50);
            transition: width 0.5s ease;
        }
        
        .advanced-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: #1a1a1a;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #fff;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #64b5f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #333;
            background: #252525;
            color: white;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #ff7961;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #81c784;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AI Stock Predictor - Advanced</h1>
            <p class="subtitle">Powered by LLMs, Deep Learning & Quantitative Analysis</p>
            <div class="ai-indicators">
                <span class="ai-badge">ðŸ§  LSTM/GRU</span>
                <span class="ai-badge">ðŸ¤– GPT-4</span>
                <span class="ai-badge">ðŸ“Š GARCH</span>
                <span class="ai-badge">ðŸŽ¯ Transformers</span>
                <span class="ai-badge">ðŸ“ˆ Prophet</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('market')">Market Overview</div>
            <div class="tab" onclick="switchTab('analysis')">Advanced Analysis</div>
            <div class="tab" onclick="switchTab('portfolio')">Portfolio Optimizer</div>
            <div class="tab" onclick="switchTab('pairs')">Pairs Trading</div>
            <div class="tab" onclick="switchTab('training')">Model Training</div>
        </div>

        <!-- Market Overview Tab -->
        <div id="market-tab" class="content-section active">
            <div class="sector-grid" id="sectors">
                <!-- Sectors will be loaded here -->
            </div>
            
            <div id="stocks-container">
                <h2 style="margin-bottom: 20px;">Select a sector to view stocks</h2>
                <div class="stock-grid" id="stocks">
                    <!-- Stocks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Advanced Analysis Tab -->
        <div id="analysis-tab" class="content-section">
            <div class="input-group">
                <input type="text" id="analysis-symbol" placeholder="Enter stock symbol (e.g., AAPL)">
                <button class="btn" onclick="runAdvancedAnalysis()">Run Analysis</button>
            </div>
            
            <div id="analysis-results">
                <!-- Analysis results will be displayed here -->
            </div>
        </div>

        <!-- Portfolio Optimizer Tab -->
        <div id="portfolio-tab" class="content-section">
            <h2>Risk Parity Portfolio Optimization</h2>
            <div class="input-group">
                <input type="text" id="portfolio-symbols" placeholder="Enter symbols separated by commas (e.g., AAPL,GOOGL,MSFT)">
                <input type="number" id="target-vol" placeholder="Target volatility (default: 0.15)" step="0.01" min="0.05" max="0.5">
                <button class="btn" onclick="optimizePortfolio()">Optimize</button>
            </div>
            
            <div id="portfolio-results">
                <!-- Portfolio optimization results will be displayed here -->
            </div>
        </div>

        <!-- Pairs Trading Tab -->
        <div id="pairs-tab" class="content-section">
            <h2>Pairs Trading Analysis</h2>
            <div class="input-group">
                <input type="text" id="pair-symbol1" placeholder="Symbol 1 (e.g., AAPL)">
                <input type="text" id="pair-symbol2" placeholder="Symbol 2 (e.g., MSFT)">
                <button class="btn" onclick="analyzePairs()">Analyze</button>
            </div>
            
            <div id="pairs-results">
                <!-- Pairs trading results will be displayed here -->
            </div>
        </div>

        <!-- Model Training Tab -->
        <div id="training-tab" class="content-section">
            <h2>Train Custom AI Models</h2>
            <div class="input-group">
                <input type="text" id="train-symbol" placeholder="Enter stock symbol to train models">
                <button class="btn" onclick="trainModels()">Start Training</button>
            </div>
            
            <div id="training-results">
                <!-- Training results will be displayed here -->
            </div>
            
            <div class="advanced-features">
                <div class="feature-card">
                    <div class="feature-icon">ðŸ§ </div>
                    <h3>LSTM Networks</h3>
                    <p>Long Short-Term Memory for pattern recognition</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ðŸ”„</div>
                    <h3>GRU Models</h3>
                    <p>Gated Recurrent Units for efficient learning</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ðŸŽ¯</div>
                    <h3>Transformers</h3>
                    <p>Attention mechanisms for complex patterns</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ðŸ“Š</div>
                    <h3>Prophet</h3>
                    <p>Facebook's time series forecasting</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-content">
                <!-- Stock details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentSector = null;
        let stocksData = {};
        let chart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSectors();
        });

        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tab}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadSectors() {
            try {
                const response = await axios.get('/api/sectors');
                const sectors = response.data.sectors;
                
                const sectorsHtml = sectors.map(sector => `
                    <div class="sector-card" onclick="loadSectorStocks('${sector}')">
                        <h3>${sector}</h3>
                        <p>${getSectorIcon(sector)}</p>
                    </div>
                `).join('');
                
                document.getElementById('sectors').innerHTML = sectorsHtml;
            } catch (error) {
                console.error('Error loading sectors:', error);
            }
        }

        function getSectorIcon(sector) {
            const icons = {
                'Technology': 'ðŸ’»',
                'Healthcare': 'ðŸ¥',
                'Finance': 'ðŸ¦',
                'Consumer': 'ðŸ›ï¸',
                'Energy': 'âš¡',
                'Industrial': 'ðŸ­'
            };
            return icons[sector] || 'ðŸ“Š';
        }

        async function loadSectorStocks(sector) {
            currentSector = sector;
            
            // Update active sector
            document.querySelectorAll('.sector-card').forEach(card => {
                card.classList.remove('active');
                if (card.querySelector('h3').textContent === sector) {
                    card.classList.add('active');
                }
            });
            
            // Show loading
            document.getElementById('stocks').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading AI analysis...</p></div>';
            
            try {
                const response = await axios.get(`/api/stocks/${sector}`);
                stocksData = response.data.stocks;
                displayStocks(stocksData);
            } catch (error) {
                console.error('Error loading stocks:', error);
                document.getElementById('stocks').innerHTML = '<div class="error">Error loading stocks. Please try again.</div>';
            }
        }

        function displayStocks(stocks) {
            const stocksHtml = stocks.map(stock => {
                const changeClass = stock.change_percent >= 0 ? 'positive' : 'negative';
                const sentiment = stock.sentiment || {};
                const recommendation = stock.recommendation || {};
                
                return `
                    <div class="stock-card" onclick="showStockDetails('${stock.symbol}')">
                        <div class="stock-header">
                            <div>
                                <div class="stock-symbol">${stock.symbol}</div>
                                <div style="font-size: 0.9em; color: #999;">${stock.name}</div>
                            </div>
                            <div>
                                <div class="stock-price">$${stock.current_price.toFixed(2)}</div>
                                <div class="${changeClass}">${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%</div>
                            </div>
                        </div>
                        
                        <div class="ai-analysis">
                            <div style="font-size: 0.85em; margin-bottom: 5px;">AI Sentiment Analysis</div>
                            <div class="sentiment-bar">
                                ${getSentimentBar(sentiment)}
                            </div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                ${sentiment.sentiment || 'Analyzing...'} (${(sentiment.confidence * 100 || 0).toFixed(0)}% confidence)
                            </div>
                        </div>
                        
                        <div class="indicators-row">
                            <div class="indicator">RSI: ${stock.indicators.rsi?.toFixed(0) || 'N/A'}</div>
                            <div class="indicator">MACD: ${stock.indicators.macd?.toFixed(2) || 'N/A'}</div>
                            <div class="indicator">${stock.quant_signals?.volatility_regime || 'Normal Vol'}</div>
                        </div>
                        
                        <div class="recommendation ${getRecommendationClass(recommendation.action)}">
                            <div style="font-size: 1.2em; font-weight: bold;">${recommendation.action || 'ANALYZING'}</div>
                            <div class="confidence-meter">
                                <span style="font-size: 0.85em;">Confidence:</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${(recommendation.confidence || 0) * 100}%"></div>
                                </div>
                                <span style="font-size: 0.85em;">${((recommendation.confidence || 0) * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('stocks').innerHTML = stocksHtml;
        }

        function getSentimentBar(sentiment) {
            const score = sentiment.score || 0;
            const positive = Math.max(0, score) * 50;
            const negative = Math.max(0, -score) * 50;
            const neutral = 100 - positive - negative;
            
            return `
                <div class="sentiment-negative" style="width: ${negative}%"></div>
                <div class="sentiment-neutral" style="width: ${neutral}%"></div>
                <div class="sentiment-positive" style="width: ${positive}%"></div>
            `;
        }

        function getRecommendationClass(action) {
            if (!action) return 'hold';
            if (action.includes('BUY')) return 'buy';
            if (action.includes('SELL')) return 'sell';
            return 'hold';
        }

        async function showStockDetails(symbol) {
            const modal = document.getElementById('stockModal');
            modal.style.display = 'block';
            
            document.getElementById('modal-content').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading advanced analysis...</p></div>';
            
            try {
                const response = await axios.get(`/api/stock/${symbol}/advanced`);
                const data = response.data;
                
                displayStockDetails(data);
            } catch (error) {
                console.error('Error loading stock details:', error);
                document.getElementById('modal-content').innerHTML = '<div class="error">Error loading analysis. Please try again.</div>';
            }
        }

        function displayStockDetails(data) {
            const html = `
                <h2>${data.symbol} - ${data.company_info.name}</h2>
                <div style="margin: 20px 0;">
                    <div class="chart-container">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                
                <div class="advanced-features">
                    <div class="feature-card">
                        <h3>Technical Analysis</h3>
                        <div style="text-align: left; font-size: 0.9em;">
                            <p>RSI: ${data.technical_analysis.rsi?.value?.toFixed(2) || 'N/A'}</p>
                            <p>MACD: ${data.technical_analysis.macd?.macd?.toFixed(2) || 'N/A'}</p>
                            <p>Signal: ${data.technical_analysis.signals?.overall || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3>Risk Metrics</h3>
                        <div style="text-align: left; font-size: 0.9em;">
                            <p>Sharpe Ratio: ${data.risk_metrics.sharpe_ratio?.toFixed(2) || 'N/A'}</p>
                            <p>Max Drawdown: ${(data.risk_metrics.max_drawdown * 100)?.toFixed(2) || 'N/A'}%</p>
                            <p>Daily VaR (95%): ${(data.risk_metrics.daily_var_95 * 100)?.toFixed(2) || 'N/A'}%</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3>AI Prediction</h3>
                        <div style="text-align: left; font-size: 0.9em;">
                            ${data.time_series_predictions.status === 'training_required' ? 
                                '<p>Models need training</p><button class="btn" onclick="trainModelsForStock(\'' + data.symbol + '\')">Train Now</button>' :
                                '<p>5-day forecast available</p>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="recommendation ${getRecommendationClass(data.recommendation.action)}" style="margin-top: 20px;">
                    <h3>${data.recommendation.action}</h3>
                    <p>AI Consensus: ${data.recommendation.ai_consensus}</p>
                    <div style="margin-top: 10px;">
                        ${data.recommendation.key_factors.map(factor => `<p style="font-size: 0.9em;">â€¢ ${factor}</p>`).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = html;
            
            // Create chart
            if (data.chart_data && data.chart_data.length > 0) {
                createStockChart(data.chart_data);
            }
        }

        function createStockChart(chartData) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => new Date(d.Date).toLocaleDateString()),
                    datasets: [{
                        label: 'Close Price',
                        data: chartData.map(d => d.close),
                        borderColor: '#64b5f6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#999'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#999'
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }

        function closeModal() {
            document.getElementById('stockModal').style.display = 'none';
        }

        // Advanced Analysis Functions
        async function runAdvancedAnalysis() {
            const symbol = document.getElementById('analysis-symbol').value.toUpperCase();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }
            
            showStockDetails(symbol);
        }

        async function optimizePortfolio() {
            const symbols = document.getElementById('portfolio-symbols').value.split(',').map(s => s.trim().toUpperCase());
            const targetVol = parseFloat(document.getElementById('target-vol').value) || 0.15;
            
            if (symbols.length < 2) {
                alert('Please enter at least 2 symbols');
                return;
            }
            
            document.getElementById('portfolio-results').innerHTML = '<div class="loading"><div class="spinner"></div><p>Optimizing portfolio...</p></div>';
            
            try {
                const response = await axios.post('/api/portfolio/optimize', {
                    symbols: symbols,
                    target_volatility: targetVol
                });
                
                displayPortfolioResults(response.data);
            } catch (error) {
                console.error('Error optimizing portfolio:', error);
                document.getElementById('portfolio-results').innerHTML = '<div class="error">Error optimizing portfolio. Please try again.</div>';
            }
        }

        function displayPortfolioResults(data) {
            const weightsHtml = Object.entries(data.weights).map(([symbol, weight]) => 
                `<p>${symbol}: ${(weight * 100).toFixed(2)}%</p>`
            ).join('');
            
            const html = `
                <div class="success">
                    <h3>Optimization Complete</h3>
                    <div style="margin-top: 15px;">
                        <h4>Optimal Weights:</h4>
                        ${weightsHtml}
                        <h4 style="margin-top: 15px;">Expected Metrics:</h4>
                        <p>Annual Return: ${(data.expected_return * 100).toFixed(2)}%</p>
                        <p>Annual Volatility: ${(data.expected_volatility * 100).toFixed(2)}%</p>
                        <p>Sharpe Ratio: ${data.sharpe_ratio.toFixed(3)}</p>
                        <p>Leverage Required: ${data.leverage.toFixed(2)}x</p>
                    </div>
                </div>
            `;
            
            document.getElementById('portfolio-results').innerHTML = html;
        }

        async function analyzePairs() {
            const symbol1 = document.getElementById('pair-symbol1').value.toUpperCase();
            const symbol2 = document.getElementById('pair-symbol2').value.toUpperCase();
            
            if (!symbol1 || !symbol2) {
                alert('Please enter both symbols');
                return;
            }
            
            document.getElementById('pairs-results').innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing pairs...</p></div>';
            
            try {
                const response = await axios.post('/api/pairs-trading', {
                    symbol1: symbol1,
                    symbol2: symbol2
                });
                
                displayPairsResults(response.data);
            } catch (error) {
                console.error('Error analyzing pairs:', error);
                document.getElementById('pairs-results').innerHTML = '<div class="error">Error analyzing pairs. Please try again.</div>';
            }
        }

        function displayPairsResults(data) {
            const analysis = data.analysis;
            const recommendation = data.recommendation;
            
            const html = `
                <div class="${analysis.is_cointegrated ? 'success' : 'error'}">
                    <h3>${data.pair} Analysis</h3>
                    <div style="margin-top: 15px;">
                        <p>Cointegrated: ${analysis.is_cointegrated ? 'Yes' : 'No'} (p-value: ${analysis.pvalue.toFixed(4)})</p>
                        <p>Current Z-Score: ${analysis.current_z_score.toFixed(2)}</p>
                        <p>Hedge Ratio: ${analysis.hedge_ratio.toFixed(4)}</p>
                        <p>Current Spread: ${analysis.current_spread.toFixed(2)}</p>
                        
                        <h4 style="margin-top: 15px;">Recommendation:</h4>
                        <div class="recommendation ${getRecommendationClass(recommendation.action)}">
                            <p style="font-size: 1.2em; font-weight: bold;">${recommendation.action}</p>
                            <p>${recommendation.reason}</p>
                            <p>Confidence: ${(recommendation.confidence * 100).toFixed(0)}%</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pairs-results').innerHTML = html;
        }

        async function trainModels() {
            const symbol = document.getElementById('train-symbol').value.toUpperCase();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }
            
            trainModelsForStock(symbol);
        }

        async function trainModelsForStock(symbol) {
            document.getElementById('training-results').innerHTML = '<div class="loading"><div class="spinner"></div><p>Training AI models... This may take several minutes.</p></div>';
            
            try {
                const response = await axios.post(`/api/train-models/${symbol}`);
                
                document.getElementById('training-results').innerHTML = `
                    <div class="success">
                        <h3>${response.data.message}</h3>
                        <p>Models trained: ${response.data.models_trained.join(', ')}</p>
                        <p>You can now run advanced analysis for ${symbol}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error training models:', error);
                document.getElementById('training-results').innerHTML = '<div class="error">Error training models. Please try again.</div>';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('stockModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html> 